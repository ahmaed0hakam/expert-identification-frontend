<div>
  <!-- Results -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-4 md:py-8">
    <div *ngIf="isLoading" class="text-center py-12">
      <div class="spinner mx-auto"></div>
      <p class="mt-4 text-gray-600">{{ 'user.loadingResults' | translate }}</p>
    </div>

    <div *ngIf="!isLoading && results.length === 0" class="text-center py-12">
      <p class="text-gray-600">{{ 'user.noResults' | translate }}</p>
    </div>

    <div *ngIf="!isLoading && results.length > 0" class="space-y-6">
      <!-- Search Again Button -->
      <div class="mb-4">
        <button (click)="searchAgain()" class="btn-primary flex items-center gap-2">
          <app-icon name="search" size="20"></app-icon>
          <span>{{ 'user.searchAgain' | translate }}</span>
        </button>
      </div>

      <!-- Query Analysis (like bombometter) - Show at top if available -->
      <div *ngIf="results[0]?.query_analysis?.item_detected"
        class="rounded-xl p-4 mb-6 bg-blue-50 border border-blue-200">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold text-blue-900 mb-1">{{ results[0].query_analysis?.item_type }}</h3>
            <p class="text-sm text-blue-800 mb-2">{{ results[0].query_analysis?.description }}</p>
            <div class="flex flex-wrap gap-2">
              <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                {{ 'user.confidence' | translate }}: {{ ((results[0].query_analysis?.confidence ?? 0) * 100).toFixed(0)
                }}%
              </span>
              <span *ngFor="let feature of (results[0].query_analysis?.key_features || [])"
                class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                {{ feature }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-xl p-4 mb-6"
        style="background-color: var(--color-primary-50); border: 1px solid var(--color-primary-200);">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <p class="text-sm" style="color: var(--color-primary-800);"
            [innerHTML]="'user.foundMatches' | translate: {count: results.length}">
          </p>
          <!-- Local Search Input -->
          <div class="relative flex-1 md:max-w-md">
            <input type="text" [(ngModel)]="searchQuery" (input)="filterResults()"
              placeholder="{{ 'user.searchInResults' | translate }}"
              class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
            <app-icon name="search" size="20"
              class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></app-icon>
          </div>
        </div>
      </div>

      <div *ngIf="filteredResults.length === 0 && searchQuery" class="text-center py-12 text-gray-500">
        {{ 'user.noSearchResults' | translate }}
      </div>

      <div *ngFor="let result of filteredResults; let i = index"
        class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer"
        (click)="showImageDetails(result)">
        <div class="flex flex-col md:flex-row">
          <!-- Image -->
          <div class="md:w-1/3 bg-gray-100 flex items-center justify-center p-4">
            <img [src]="getImageUrl(result)" [alt]="result.title" class="max-h-64 w-full object-contain"
              (error)="onImageError($event)" />
          </div>

          <!-- Details -->
          <div class="md:w-2/3 p-6">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ result.title }}</h2>
                <p class="text-sm text-gray-500 mb-1" *ngIf="result.category">
                  {{ 'admin.category' | translate }}: <span class="font-semibold">{{ result.category }}</span>
                </p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold" style="color: var(--color-primary-600);">{{ result.accuracy_score }}%
                </div>
                <div class="text-xs text-gray-500">{{ 'user.confidence' | translate }}</div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-4">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="result.accuracy_score"
                  [ngClass]="getAccuracyColor(result.accuracy_score)"></div>
              </div>
            </div>

            <!-- Catalog Section -->
            <div *ngIf="result.has_catalog" class="mb-4 p-3 rounded-lg border"
              style="background-color: var(--color-primary-50); border-color: var(--color-primary-200);">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <app-icon name="file" size="20" style="color: var(--color-primary-600);"
                    class="flex-shrink-0"></app-icon>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-semibold mb-1" style="color: var(--color-primary-800);">{{
                      'user.catalogAvailable' | translate }}</p>
                    <p class="text-xs truncate" style="color: var(--color-primary-700);" *ngIf="result.catalog_filename"
                      [title]="result.catalog_filename">
                      {{ result.catalog_filename }}
                    </p>
                  </div>
                </div>
                <button (click)="downloadCatalog(result); $event.stopPropagation()"
                  class="btn-primary btn-primary-sm flex items-center gap-1 flex-shrink-0"
                  [title]="result.catalog_filename || 'Download Catalog'">
                  <app-icon name="download" size="16"></app-icon>
                  <span>{{ 'user.downloadCatalog' | translate }}</span>
                </button>
              </div>
            </div>

            <!-- Description -->
            <div *ngIf="result.description" class="mb-4">
              <h3 class="text-sm font-semibold text-gray-700 mb-2">{{ 'admin.description' | translate }}</h3>
              <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">{{ result.description }}</p>
            </div>

            <!-- AI Reasoning -->
            <div *ngIf="result.ai_reasoning" class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-start gap-2 mb-1">
                <svg class="w-4 h-4 text-gray-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                  </path>
                </svg>
                <h3 class="text-xs font-semibold text-gray-600">{{ 'user.aiAnalysis' | translate }}</h3>
              </div>
              <p class="text-xs text-gray-700 leading-relaxed">{{ result.ai_reasoning }}</p>
            </div>

            <!-- Rank Badge and Actions -->
            <div class="flex items-center gap-2 flex-wrap justify-between">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                        'bg-yellow-100 text-yellow-800': i === 0,
                        'bg-gray-100 text-gray-800': i > 0
                      }">
                  {{ 'user.match' | translate: {num: i + 1} }}
                </span>
                <span *ngIf="result.ai_confidence" class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded">
                  {{ 'user.aiConfidence' | translate }}: {{ (result.ai_confidence * 100).toFixed(0) }}%
                </span>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Image Detail Modal -->
  <app-image-detail-modal [isOpen]="showImageDetail" [image]="selectedImageDetail" [imageUrl]="selectedImageDetailUrl"
    [catalogDownloadHandler]="getCatalogDownloadHandler()" (closeModal)="closeImageDetail()"></app-image-detail-modal>
</div>