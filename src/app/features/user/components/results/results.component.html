<div>
  <!-- Results -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-4 md:py-8">
    <div *ngIf="isLoading" class="text-center py-12">
      <div class="spinner mx-auto"></div>
      <p class="mt-4 text-gray-600">{{ 'user.loadingResults' | translate }}</p>
    </div>

    <div *ngIf="!isLoading && results.length === 0" class="text-center py-12">
      <p class="text-gray-600">{{ 'user.noResults' | translate }}</p>
    </div>

    <div *ngIf="!isLoading && results.length > 0" class="space-y-6">
      <!-- Search Again Button -->
      <div class="mb-4">
        <button (click)="searchAgain()" class="btn-primary flex items-center gap-2">
          <app-icon name="search" size="20"></app-icon>
          <span>{{ 'user.searchAgain' | translate }}</span>
        </button>
      </div>

      <!-- Query Analysis (like bombometter) - Show at top if available -->
      <div *ngIf="results[0]?.query_analysis?.item_detected"
        class="rounded-xl p-4 mb-6 bg-blue-50 border border-blue-200">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold text-blue-900 mb-1">{{ results[0].query_analysis?.item_type }}</h3>
            <p class="text-sm text-blue-800 mb-2">{{ results[0].query_analysis?.description }}</p>
            <div class="flex flex-wrap gap-2">
              <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                {{ 'user.confidence' | translate }}: {{ ((results[0].query_analysis?.confidence ?? 0) * 100).toFixed(0)
                }}%
              </span>
              <span *ngFor="let feature of (results[0].query_analysis?.key_features || [])"
                class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">
                {{ feature }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-xl p-4 mb-6"
        style="background-color: var(--color-primary-50); border: 1px solid var(--color-primary-200);">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <p class="text-sm" style="color: var(--color-primary-800);"
            [innerHTML]="'user.foundMatches' | translate: {count: results.length}">
          </p>
          <!-- Local Search Input -->
          <div class="relative flex-1 md:max-w-md">
            <input type="text" [(ngModel)]="searchQuery" (input)="filterResults()"
              placeholder="{{ 'user.searchInResults' | translate }}"
              class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" />
            <app-icon name="search" size="20"
              class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></app-icon>
          </div>
        </div>
      </div>

      <div *ngIf="filteredResults.length === 0 && searchQuery" class="text-center py-12 text-gray-500">
        {{ 'user.noSearchResults' | translate }}
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div *ngFor="let result of filteredResults; let i = index"
          class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition relative cursor-pointer flex flex-col"
          (click)="showImageDetails(result)">
          
          <!-- Image Preview -->
          <div class="bg-gray-100 h-48 flex items-center justify-center overflow-hidden relative">
            <img [src]="getImageUrl(result)" [alt]="result.title" 
              class="max-h-full max-w-full object-contain" (error)="onImageError($event)" />
            
          </div>
          <!-- Card Details -->
          <div class="p-3 md:p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-start mb-2 gap-2">
              <h3 class="font-semibold text-gray-800 break-words flex-1" [title]="result.title">
                {{ result.title }}
              </h3>
              <div class="accuracy-badge text-[10px] shrink-0" [ngClass]="getAccuracyColor(result.accuracy_score)">
                {{ result.accuracy_score }}%
              </div>
            </div>

            <p *ngIf="result.category" class="text-xs text-gray-500 mb-2 break-words">
              {{ 'admin.category' | translate }}: {{ result.category }}
            </p>

            <!-- Progress Bar (Compact) -->
            <div class="mb-3">
              <div class="progress-bar-sm">
                <div class="progress-fill" [style.width.%]="result.accuracy_score"
                  [ngClass]="getAccuracyColor(result.accuracy_score)"></div>
              </div>
            </div>

            <!-- Description -->
            <p *ngIf="result.description" class="text-sm text-gray-600 mb-3 line-clamp-2 break-words">
              {{ result.description }}
            </p>

            <!-- AI Analysis (Compact) -->
            <div *ngIf="result.ai_reasoning" class="mb-3 p-2 bg-gray-50 rounded-lg border border-gray-100 text-[10px] leading-relaxed text-gray-700 line-clamp-3">
              <div class="flex items-center gap-1 mb-1 font-semibold text-gray-600">
                <app-icon name="info" size="10"></app-icon>
                {{ 'user.aiAnalysis' | translate }}
              </div>
              {{ result.ai_reasoning }}
            </div>

            <!-- Catalog Download (If Available) -->
            <div class="mt-auto pt-2">
              <button *ngIf="result.has_catalog" (click)="downloadCatalog(result); $event.stopPropagation()"
                class="w-full btn-primary btn-primary-sm flex items-center justify-center gap-1">
                <app-icon name="download" size="14"></app-icon>
                <span>{{ 'user.downloadCatalog' | translate }}</span>
              </button>
              <button *ngIf="!result.has_catalog" (click)="showImageDetails(result)"
                class="w-full btn-secondary btn-secondary-sm flex items-center justify-center gap-1">
                <app-icon name="image" size="14"></app-icon>
                <span>{{ 'common.viewDetails' | translate }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Image Detail Modal -->
  <app-image-detail-modal [isOpen]="showImageDetail" [image]="selectedImageDetail" [imageUrl]="selectedImageDetailUrl"
    [catalogDownloadHandler]="getCatalogDownloadHandler()" (closeModal)="closeImageDetail()"></app-image-detail-modal>
</div>